<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MBTI 투표 및 비교</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Noto+Sans+KR:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', 'Noto Sans KR', 'Roboto', Arial, sans-serif;
            padding: 20px;
        }
        .note {
            color: red;
            font-size: 0.9em;
            margin-left: 10px;
        }
        .bold {
            font-weight: bold;
        }
        .disabled-label {
            color: gray;
        }
        .voter-name-container {
            margin-bottom: 20px;
        }
        .form-container {
            display: flex;
            justify-content: space-between;
        }
        .name-column, .mbti-column {
            width: 45%;
        }
        .header-title {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .header-title img {
            width: 150px; /* Adjust size as needed */
            height: auto;
        }
        .header-title h1 {
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <div class="header-title">
        <img src="{{ url_for('static', filename='enfp.png') }}" alt="INTJ Image">
        <h1>팀원들의 MBTI 투표 및 비교 ver 1.3</h1>
        <img src="{{ url_for('static', filename='02.perfect_intj.png') }}" alt="ENFP Image">
    </div>
    <div id="timer" class="timer-box">
        남은 투표 시간: <span id="time">12:00:00</span>
    </div>
    <div class="voter-name-container">
        <label>투표자 이름: <input type="text" id="username" required><span class="note"> 가능한 실명에 가깝게 부탁드려요~</span></label>
    </div>
    <form id="voteForm" class="vote-form">
        <h2>투표하기</h2>
        <div class="form-container">
            <div class="name-column">
                {% for name in names %}
                <label id="label-{{ name }}">
                    <input type="radio" name="name" value="{{ name }}">
                    {{ name }}
                </label><br>
                {% endfor %}
            </div>
            <div class="mbti-column">
                {% for mbti in mbtis %}
                <label>
                    <input type="radio" name="mbti" value="{{ mbti }}" required>
                    {{ mbti }}
                </label><br>
                {% endfor %}
            </div>
        </div>
        <button type="submit">투표하기</button>
    </form>

    <button id="compareButton">투표 MBTI와 진짜 MBTI 비교하기</button>

    <h2>투표 결과</h2>
    <div id="results">
        <img id="resultsImage" src="{{ url_for('results') }}" alt="결과 그래프">
    </div>

    <script>
        const userVotes = {{ user_votes | tojson | safe }};
        const endTime = {{ end_time | tojson | safe }};
        
        window.onload = function() {
            // Disable already voted radio buttons
            userVotes.forEach(name => {
                const label = document.getElementById(`label-${name}`);
                if (label) {
                    const input = label.querySelector('input[type="radio"]');
                    input.disabled = true;
                    label.classList.add('disabled-label');

                    label.addEventListener('click', function() {
                        const confirmReVote = confirm('재투표하시겠습니까?');
                        if (confirmReVote) {
                            fetch('/delete_vote', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ voterName: document.getElementById('username').value, name: name })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    input.disabled = false;
                                    label.classList.remove('disabled-label');
                                }
                                alert(data.message);
                            });
                        }
                    });
                }
            });

            // Start timer
            function startTimer(endTime, display) {
                function updateTimer() {
                    const now = new Date().getTime() / 1000;
                    const timeLeft = endTime - now;

                    const hours = Math.floor(timeLeft / 3600);
                    const minutes = Math.floor((timeLeft % 3600) / 60);
                    const seconds = Math.floor(timeLeft % 60);

                    display.textContent = 
                        (hours < 10 ? "0" : "") + hours + ":" + 
                        (minutes < 10 ? "0" : "") + minutes + ":" + 
                        (seconds < 10 ? "0" : "") + seconds;

                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        display.textContent = "00:00:00";
                    }
                }

                updateTimer();
                const timerInterval = setInterval(updateTimer, 1000);
            }

            const display = document.querySelector('#time');
            startTimer(endTime, display);
        };

        document.getElementById('voteForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const voterName = document.getElementById('username').value;
            const name = document.querySelector('input[name="name"]:checked').value;
            const mbti = document.querySelector('input[name="mbti"]:checked').value;

            fetch('/vote', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ voterName, name, mbti })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.status === 'success') {
                    location.reload();
                }
            });
        });

        document.getElementById('compareButton').addEventListener('click', function() {
            window.location.href = '{{ url_for("compare") }}';
        });
    </script>
</body>
</html>
